# Docker Compose for MPI Cluster Simulation
#
# Creates a 3-node cluster:
#   - mpi-master: Orchestrates MPI jobs
#   - mpi-worker-1: Worker node
#   - mpi-worker-2: Worker node
#
# Usage:
#   docker-compose up -d
#   docker exec mpi-master mpirun -np 3 --hostfile /app/hostfile /app/primes-mpi
version: "3.8"

services:
  mpi-master:
    build:
      context: .
      dockerfile: Dockerfile.mpi-node
    container_name: mpi-master
    hostname: mpi-master
    networks:
      - mpi-net
    volumes:
      - ./shared:/app/shared
      - ssh-key-vol:/root/.ssh  # shared SSH keys
    environment:
      - OMPI_MCA_btl_tcp_if_include=eth0
      - OMPI_MCA_oob_tcp_if_include=eth0
      - OMPI_MCA_orte_keep_fqdn_hostnames=1
    command: ["/usr/sbin/sshd", "-D"]

  mpi-worker-1:
    build:
      context: .
      dockerfile: Dockerfile.mpi-node
    container_name: mpi-worker-1
    hostname: mpi-worker-1
    networks:
      - mpi-net
    volumes:
      - ./shared:/app/shared
      - ssh-key-vol:/root/.ssh
    environment:
      - OMPI_MCA_btl_tcp_if_include=eth0
      - OMPI_MCA_oob_tcp_if_include=eth0
    depends_on:
      - mpi-master
    command: ["/usr/sbin/sshd", "-D"]

  mpi-worker-2:
    build:
      context: .
      dockerfile: Dockerfile.mpi-node
    container_name: mpi-worker-2
    hostname: mpi-worker-2
    networks:
      - mpi-net
    volumes:
      - ./shared:/app/shared
      - ssh-key-vol:/root/.ssh
    environment:
      - OMPI_MCA_btl_tcp_if_include=eth0
      - OMPI_MCA_oob_tcp_if_include=eth0
    depends_on:
      - mpi-master
    command: ["/usr/sbin/sshd", "-D"]

volumes:
  ssh-key-vol:

networks:
  mpi-net:
    driver: bridge